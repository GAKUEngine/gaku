/*
 *
 * Wijmo Library 2.0.0
 * http://wijmo.com/
 *
 * Copyright(c) ComponentOne, LLC.  All rights reserved.
 * 
 * Dual licensed under the MIT or GPL Version 2 licenses.
 * licensing@wijmo.com
 * http://www.wijmo.com/license
 *
 **/
(function(a){"use strict";a.widget("wijmo.wijdropdown",{options:{zIndex:1e3,showingAnimation:{effect:"blind"},hidingAnimation:{effect:"blind"}},hoverClass:"ui-state-hover",activeClass:"ui-state-active",focusClass:"ui-state-focus",_setOption:function(c,b){a.Widget.prototype._setOption.apply(this,arguments);if(c==="disabled"){this._labelWrap.toggleClass("ui-state-disabled",b);this.element.attr("disabled",b?"disabled":"")}},_create:function(){var a=this,b=a.element;if(b.get(0).tagName.toLowerCase()!=="select")return;if(b.is(":visible")){a._activeItem=null;a._createSelect();a._bindEvents();a.needInit=false}else a.needInit=true},_createSelect:function(){var b=this,c=b.element,k=c.width(),e=k,j=c.wrap("<div></div>").parent().addClass("ui-helper-hidden"),g=j.wrap("<div></div>").parent().attr("role","select").addClass("wijmo-wijdropdown ui-widget ui-widwijmo-wijdropdownt-content ui-state-default ui-corner-all ui-helper-clearfix"),h=a('<label class="wijmo-dropdown-label ui-corner-all"></label>').attr("id",c.get(0).id+"_select").attr("name",c.attr("name")||""),i=a("<div></div>").addClass("wijmo-dropdown-trigger ui-state-default ui-corner-right"),d=a('<a href="#"></a>'),f=a("<div>").addClass("wijmo-dropdown"),l=a("<ul></ul>").addClass("wijmo-dropdown-list ui-widget-content ui-widget ui-corner-all ui-helper-reset").appendTo(f);a("<span></span>").addClass("ui-icon ui-icon-triangle-1-s").appendTo(i);k=Math.max(k,g.width());c.get(0).tabIndex!==""&&d.attr("tabindex",c.attr("tabindex"));if(c.get(0).disabled!==false){b.options.disabled=true;d.addClass("ui-state-disabled")}d.append(h);g.append(j).append(d).append(i).append(f);e+=parseInt(h.css("padding-left").replace(/px/,""),10);e+=parseInt(h.css("padding-right").replace(/px/,""),10);e-=16;g.width(e);b._buildList(l,f,e);b._rightTrigger=i;b._label=h;b._listContainer=f;b._list=l;b._value=c.val();b._selectWrap=j;b._labelWrap=d;b._container=g},_buildList:function(c,b,f){var d=this,g=d.element,e;b.show();g.children().each(function(i,h){var b=a(h),f,g,e;if(b.is("option"))c.append(d._buildItem(b));else{f=a('<li class="wijmo-dropdown-optgroup"></li>');g=a("<span>"+b.attr("label")+"</span>").addClass("wijmo-optgroup-header ui-priority-primary");e=a("<ul></ul>").addClass("ui-helper-reset wijmo-dropdown-items");b.children("option").each(function(){e.append(d._buildItem(a(this)))});f.append(g).append(e);c.append(f)}});b.height("");e=b.height();e=c.outerHeight()<e?c.outerHeight():e;b.css({height:e,width:f});if(b.data("wijsuperpanel")){b.wijsuperpanel("paintPanel");d.superpanel=b.data("wijsuperpanel")}else d.superpanel=b.wijsuperpanel().data("wijsuperpanel");a.fn.bgiframe&&d.superpanel.element.bgiframe();c.setOutWidth(c.parent().parent().innerWidth());b.hide()},_handelEvents:function(d){var a=this,b="."+a.widgetName,c=a.element;d.bind("click"+b,function(b){if(a.options.disabled)return;if(a._listContainer.is(":hidden"))a._show();else a._hide();c.click();if(d.get(0)===a._label.get(0))b.preventDefault();else a._labelWrap.focus()}).bind("mouseover"+b,function(){if(a.options.disabled)return;a._label.addClass(a.hoverClass);a._rightTrigger.addClass(a.hoverClass);c.trigger("mouseover")}).bind("mouseout"+b,function(){if(a.options.disabled)return;a._label.removeClass(a.hoverClass);a._rightTrigger.removeClass(a.hoverClass);c.trigger("mouseout")}).bind("mousedown"+b,function(){if(a.options.disabled)return;a._label.addClass(a.activeClass);a._rightTrigger.addClass(a.activeClass);c.trigger("mousedown")}).bind("mouseup"+b,function(){if(a.options.disabled)return;a._label.removeClass(a.activeClass);a._rightTrigger.removeClass(a.activeClass);c.trigger("mouseup")})},_bindEvents:function(){var b=this,e="."+b.widgetName,h=b._label,g=b._rightTrigger,i=b._labelWrap,d=b._listContainer,c=b.element,f;b._handelEvents(b._label);b._handelEvents(b._rightTrigger);a(document.body).bind("click"+e,function(a){if(d.is(":hidden"))return;f=d.offset();if(a.target===h.get(0)||a.target===g.get(0)||a.target===g.children().get(0))return;(a.pageX<f.left||a.pageX>f.left+d.width()||a.pageY<f.top||a.pageY>f.top+d.height())&&b._hide()});d.bind("click"+e,function(f){var e=a(f.target);if(e.closest("li.wijmo-dropdown-item",a(this)).length>0){b._setValue();d.css("z-index","");a.browser.msie&&/^[6,7].[0-9]+/.test(a.browser.version)&&d.parent().css("z-index","");d.hide();b.oldVal=c.val();c.val(b._value);b.oldVal!==b._value&&c.trigger("change")}c.click()});i.bind("keydown"+e,function(e){if(b.options.disabled)return;var d=a.ui.keyCode;switch(e.which){case d.UP:case d.LEFT:b._previous();b._setValue();b._setValueToEle();break;case d.DOWN:case d.RIGHT:b._next();b._setValue();b._setValueToEle();break;case d.PAGE_DOWN:b._nextPage();b._setValue();b._setValueToEle();break;case d.PAGE_UP:b._previousPage();b._setValue();b._setValueToEle();break;case d.ENTER:case d.NUMPAD_ENTER:b._setValue();b._listContainer.hide();b._setValueToEle()}e.which!==d.TAB&&e.preventDefault();c.trigger("keydown")}).bind("focus"+e,function(){if(b.options.disabled)return;h.addClass(b.focusClass);g.addClass(b.focusClass);c.focus()}).bind("blur"+e,function(){if(b.options.disabled)return;h.removeClass(b.focusClass);g.removeClass(b.focusClass);c.trigger("blur")}).bind("keypress"+e,function(){if(b.options.disabled)return;c.trigger("keypress")}).bind("keyup"+e,function(){if(b.options.disabled)return;c.trigger("keyup")})},_init:function(){var a=this;a._initActiveItem();a._activeItem&&a._label.text(a._activeItem.text())},_buildItem:function(d){var f=d.val(),b=d.text(),e=this,c;if(b==="")b="&nbsp;";c=a('<li class="wijmo-dropdown-item ui-corner-all"><span>'+b+"</span></li>").mousemove(function(b){var c=a(b.target).closest(".wijmo-dropdown-item");c!==this.last&&e._activate(a(this));this.last=a(b.target).closest(".wijmo-dropdown-item")}).attr("role","option");c.data("value",f);return c},_show:function(){var d=this,c=d._listContainer,b=d.options.showingAnimation;c.css("z-index","100000");a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)&&c.parent().css("z-index","99999");if(b)c.stop().show(b.effect,b.options,b.speed,function(){d._initActiveItem()});else c.show()},_hide:function(){var d=this,b=d._listContainer,c=d.options.hidingAnimation;if(b.is(":hidden"))return;if(c)b.stop(false,true).hide(c.effect,c.options,c.speed,function(){a.isFunction(c.callback)&&c.callback.apply(d,arguments);a.browser.msie&&/^[6,7]\.[0-9]+/.test(a.browser.version)&&b.parent().css("z-index","");b.css("z-index","")});else{a.browser.msie&&a.browser.version==="6.0"&&b.parent().css("z-index","");b.css("z-index","");b.hide()}},_setValue:function(){var a=this,b=a._listContainer,c,d;if(a._activeItem){a._label.text(a._activeItem.text());a._value=a._activeItem.data("value");if(a.superpanel.vNeedScrollBar){c=a._activeItem.offset().top;d=a._activeItem.outerHeight();if(b.offset().top>c)b.wijsuperpanel("scrollTo",0,c-a._list.offset().top);else b.offset().top<c+d-b.innerHeight()&&b.wijsuperpanel("scrollTo",0,c+d-b.height()-a._list.offset().top)}}},_setValueToEle:function(){var a=this,b=a.element;a.oldVal=b.val();b.val(a._value);a.oldVal!==a._value&&b.trigger("change")},_initActiveItem:function(){var b=this;b._value!==undefined&&b._list.find("li.wijmo-dropdown-item").each(function(){a(this).data("value")===b._value&&b._activate(a(this))})},_activate:function(b){var a=this;a._deactivate();a._activeItem=b;a._activeItem.addClass(a.hoverClass).attr("aria-selected",true)},_deactivate:function(){var a=this;a._activeItem&&a._activeItem.removeClass(a.hoverClass).attr("aria-selected",false)},_next:function(){this._move("next","first")},_previous:function(){this._move("prev","last")},_nextPage:function(){this._movePage("first")},_previousPage:function(){this._movePage("last")},refresh:function(){var a=this,b;if(a.needInit){if(a.element.is(":visible")){a._activeItem=null;a._createSelect();a._bindEvents();a._init();a.needInit=false}}else{if(!a._list)return;a._listContainer.show();a._selectWrap.removeClass("ui-helper-hidden");b=a.element.width();b+=parseInt(a._label.css("padding-left").replace(/px/,""),10);b+=parseInt(a._label.css("padding-right").replace(/px/,""),10);b-=16;a._container.width(b);a._selectWrap.addClass("ui-helper-hidden");a._list.empty();a._buildList(a._list,a._listContainer,b);a._value=a.element.val();a._initActiveItem();a._activeItem&&a._label.text(a._activeItem.text())}},_move:function(c,d){var a=this,e,b;if(!a._activeItem){a._activate(a._list.find(".wijmo-dropdown-item:"+d));return}e=a._activeItem[c]().eq(0);if(e.length)b=a._getNextItem(e,c,d);else if(a._activeItem.closest(".wijmo-dropdown-optgroup").length)b=a._getNextItem(a._activeItem.closest(".wijmo-dropdown-optgroup")[c](),c,d);if(b&&b.length)a._activate(b);else a._activate(a._list.find(".wijmo-dropdown-item:"+d))},_movePage:function(d){var b=this,g,e,c,f=d==="first"?"last":"first";if(b.superpanel.vNeedScrollBar){g=b._activeItem.offset().top;e=b.options.height;c=b._list.find(".wijmo-dropdown-item").filter(function(){var c=a(this).offset().top-g+(d==="first"?-e:e)+a(this).height(),b=a(this).height();return c<b&&c>-b});if(!c.length)c=b._list.find(".wijmo-dropdown-item:"+f);b._activate(c)}else b._activate(b._list.find(".wijmo-dropdown-item:"+(!b._activeItem?d:f)))},_getNextItem:function(a,b,c){if(a.length)if(a.is(".wijmo-dropdown-optgroup"))if(!!a.find(">ul>li.wijmo-dropdown-item").length)return a.find(">ul>li.wijmo-dropdown-item:"+c).eq(0);else this._getNextItem(a[b]().eq(0));else return a},destroy:function(){this.element.closest(".wijmo-wijdropdown").find(">div.wijmo-dropdown-trigger,>div.wijmo-dropdown,>a").remove();this.element.unwrap().unwrap().removeData("maxZIndex");a.Widget.prototype.destroy.apply(this)}})})(jQuery);